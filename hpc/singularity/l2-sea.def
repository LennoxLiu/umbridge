Bootstrap: library
From: ubuntu:latest

%post
    # Install dependencies
    apt update && \
    DEBIAN_FRONTEND="noninteractive" apt install -y python3-pip gfortran liblapack-dev libblas-dev libomp-dev git && \
    pip install umbridge f90nml

    # Install NATO-AVT-331-L2-Sea-Benchmark model
    git clone https://github.com/MAORG-CNR-INM/NATO-AVT-331-L2-Sea-Benchmark.git
    cd NATO-AVT-331-L2-Sea-Benchmark && make
    mkdir -p /NATO-AVT-331-L2-Sea-Benchmark/examples/DTMB-5415/CPU000

    # Create empty folder to store output
    mkdir /output
    # Create symbolic link to output folder
    # ln -s /NATO-AVT-331-L2-Sea-Benchmark/examples/DTMB-5415/CPU000 /output
    
    # Create empty folder to load from local file at runtime
    mkdir /umbridge-server

    # Install UM-Bridge server from repository (can't specify port)
    #git clone --depth 1 --branch main https://github.com/UM-Bridge/benchmarks.git && \
    #cp benchmarks/models/l2-sea/umbridge-server.py /umbridge-server.py

%runscript
    ulimit -s unlimited

    # check if port is specified
    if [ -z "$1" ]; then
        port="4242"
    else
        port=$1
    fi

    python3 /umbridge-server/umbridge-server.py $port

    cp /NATO-AVT-331-L2-Sea-Benchmark/examples/DTMB-5415/CPU000/* /output/
    
