Bootstrap: library
From: ubuntu:latest

%post
    apt update && \
    DEBIAN_FRONTEND="noninteractive" apt install -y python3-pip gfortran liblapack-dev libblas-dev libomp-dev git && \
    pip install umbridge f90nml

    # Clone UM-Bridge repository
    git clone https://github.com/UM-Bridge/umbridge.git /umbridge && \
    cd /umbridge/hpc && \
    
    # Build load balancer
    make


%runscript
    # Replace configuration files of HyperQueue with local files
    rm -rf /umbridge/hpc/hq_scripts && \
    cp -r hq_scripts /umbridge/hpc/

    # check if port is specified when running singularity
    if [ -z "$1" ]; then
        port="4242"
    else
        port=$1
    fi
    export PORT=$port

    # Run load balancer
    # set port by envrionment variable PORT at login node
    /umbridge/hpc/load-balancer


