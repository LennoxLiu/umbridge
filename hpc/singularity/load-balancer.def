Bootstrap: library
From: ubuntu:latest

%post
    # Install dependencies
    apt update && \
    DEBIAN_FRONTEND="noninteractive" apt install -y python3-pip gfortran liblapack-dev libblas-dev libomp-dev git wget && \
    pip install umbridge f90nml

    # Clone UM-Bridge repository
    git clone https://github.com/UM-Bridge/umbridge.git /umbridge && \
    cd /umbridge/hpc && \
    # Build load balancer
    make build-load-balancer
    # cp load-balancer /

    # Install HyperQueue v0.17.0
    wget https://github.com/It4innovations/hyperqueue/releases/download/v0.17.0/hq-v0.17.0-linux-x64.tar.gz && \
    tar -xvzf hq-v0.17.0-linux-x64.tar.gz && \
    mv hq /usr/local/bin

    # Create empty folder for config files for HyperQueue (Firstly, create an empty folder)
    mkdir -p /load-balancer_singularity

%runscript
    # copy load balancer in container to /load-balancer_singularity (Thirdly, copy the load balancer to the working folder)
    cp /umbridge/hpc/load-balancer /load-balancer_singularity/

    # check if port is specified when running singularity
    if [ -z "$1" ]; then
        port="4242"
    else
        port=$1
    fi
    export PORT=$port

    # change $HOME for HyperQueue, which by default set server directory as $HOME/.hq-server
    export HOME=/load-balancer_singularity

    # Run load balancer
    # set port by envrionment variable PORT at login node
    ./load-balancer


